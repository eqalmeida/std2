<?xml version='1.0' encoding='UTF-8' ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core">

    <h:head></h:head>
    <h:body>

        <ui:composition template="./WEB-INF/templates/templatePrincipal.xhtml">

            <ui:define name="top">

                <ui:include src="./WEB-INF/inc/logotipo.xhtml" />

            </ui:define>

            <ui:define name="left">
                <h:form id="fmenu">
                    <p:menu>
                        <p:submenu label="Opções">
                            <p:menuitem 
                                value="Novo"
                                icon="ui-icon-plus" 
                                actionListener="#{tabelaFinancBean.novo}" 
                                update=":fEdit,:form, @form"
                                oncomplete="tblDlg.show()"/>
                        </p:submenu>
                        <p:submenu label="Selecionado">

                            <p:menuitem 
                                value="Editar"
                                disabled="#{not(tabelaFinancBean.selected.id > 0)}"
                                icon="ui-icon-pencil" 
                                update=":fEdit" 
                                oncomplete="tblDlg.show()" />

                            <p:menuitem
                                value="Excluir"
                                icon="ui-icon-trash"
                                disabled="#{not(tabelaFinancBean.selected.id > 0)}"
                                update=":form"
                                actionListener="#{tabelaFinancBean.excluir}"/>

                            <p:menuitem 
                                disabled="#{not(tabelaFinancBean.selected.id > 0)}"
                                icon="ui-icon-plus" value="Novo coeficiente" 
                                update=":fCoef"
                                actionListener="#{tabelaFinancBean.novoCoef}" />
                            
                        </p:submenu>
                    </p:menu>
                </h:form>
            </ui:define>

            <ui:define name="content">

                <p:growl autoUpdate="true" id="message"/>

                <h:form id="form">

                    <p:dataTable 
                        selection="#{tabelaFinancBean.selected}" selectionMode="single" rowKey="#{it.id}"
                        value="#{tabelaFinancBean.tabelas}" var="it">

                        <f:facet name="header">Tabelas de Financiamento</f:facet>

                        <p:ajax event="rowSelect" update="@form, :fmenu" />

                        <p:column headerText="Descrição">
                            #{it.descricao}
                        </p:column>

                        <p:column headerText="Multa (%)">
                            <h:outputText value="#{it.multaPercent}"></h:outputText>
                        </p:column>

                        <p:column headerText="Multa ($)">
                            <h:outputText value="#{it.multaVal}"><f:convertNumber type="currency"/></h:outputText>
                        </p:column>

                        <p:column headerText="Juros diário (%)">
                            <h:outputText value="#{it.jurosDiario}"></h:outputText>
                        </p:column>
                    </p:dataTable>

                    <h:panelGroup rendered="#{tabelaFinancBean.selected.id > 0}">

                        <br/>

                        <p:contextMenu for="tbl">  
                            <p:menuitem value="Editar" update=":fCoef" icon="ui-icon-pencil" actionListener="#{tabelaFinancBean.editarCoef}"/>  
                            <p:menuitem value="Excluir" update="tbl" icon="ui-icon-trash" actionListener="#{tabelaFinancBean.excluirCoef}"/>  
                        </p:contextMenu>  

                        <p:dataTable id="tbl" value="#{tabelaFinancBean.subItems}" 
                                     rowKey="#{coef.coeficientePK}"
                                     selectionMode="single"
                                     selection="#{tabelaFinancBean.subItem}"
                                     var="coef" tableStyle="width: auto">

                            <f:facet name="header">
                                <h:outputText value="Coeficientes de: #{tabelaFinancBean.selected.descricao}" />
                            </f:facet>

                            <p:column headerText="Num. Parcelas">
                                <h:outputText value="#{coef.coeficientePK.numParcelas}"/>
                            </p:column>

                            <p:column headerText="Coeficiente">
                                <h:outputText value="#{coef.coeficiente}"/>
                            </p:column>

                        </p:dataTable>
                    </h:panelGroup>


                </h:form>


                <h:form id="fEdit">

                    <p:dialog 
                        header="#{tabelaFinancBean.selected.id > 0 ? 'Editando' : 'Adicionando' } Tabela de Financiamento"
                        resizable="false" modal="true" 
                        id="tabelaDlg" widgetVar="tblDlg">

                        <h:inputHidden value="#{tabelaFinancBean.selected.id}" />

                        <p:panelGrid columns="2" id="editGrid">
                            <h:outputText value="Descrição:" />
                            <p:inputText value="#{tabelaFinancBean.selected.descricao}" label="Descrição" required="true"/>

                            <h:outputText value="Multa (%):" />
                            <p:inputText value="#{tabelaFinancBean.selected.multaPercent}" label="Multa (%)" required="true"/>

                            <h:outputText value="Multa ($):" />
                            <p:inputText value="#{tabelaFinancBean.selected.multaVal}" label="Multa (%)" required="true"/>

                            <h:outputText value="Juros diário (%):" />
                            <p:inputText value="#{tabelaFinancBean.selected.jurosDiario}" label="Juros diário" required="true" />

                        </p:panelGrid>

                        <f:facet name="footer">
                            <p:commandButton value="Gravar" 
                                             actionListener="#{tabelaFinancBean.gravar}" 
                                             update=":form, editGrid" />

                        </f:facet>
                    </p:dialog>
                </h:form>

                <h:form id="fCoef">
 
                    <p:dialog 
                        resizable="false"
                        showEffect="explode"
                        modal="true"
                        widgetVar="coefDlg" 
                        header="#{tabelaFinancBean.subItem.coeficientePK.tabelaFinanc > 0 ? 'Editando' : 'Inserindo'} Coeficiente">
                        
                        <h:inputHidden value="#{tabelaFinancBean.subItem.coeficientePK.tabelaFinanc}"/>

                        <p:panelGrid columns="2" id="coefGrid">

                            <h:outputText value="N. Parcelas:" />
                            <p:inputText value="#{tabelaFinancBean.subItem.coeficientePK.numParcelas}" label="N. Parcelas" required="true"/>

                            <h:outputText value="Coeficiente:" />
                            <p:inputText value="#{tabelaFinancBean.subItem.coeficiente}" label="Coeficiente" required="true"/>

                        </p:panelGrid>

                        <f:facet name="footer">

                            <p:commandButton 
                                value="Gravar" 
                                actionListener="#{tabelaFinancBean.gravarCoef}" 
                                update=":form, coefGrid" />
                            
                        </f:facet>
                    </p:dialog>
                </h:form>

            </ui:define>
        </ui:composition> 
    </h:body> 
</html>